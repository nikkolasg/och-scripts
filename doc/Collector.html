<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>Class: Collector</title>

  <link rel="stylesheet" href="./rdoc.css" type="text/css" media="screen" />

  <script src="./js/jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/thickbox-compressed.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/quicksearch.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/darkfish.js" type="text/javascript" charset="utf-8"></script>

</head>
<body id="top" class="class">

  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="./index.html">Home</a>
          <a href="./index.html#classes">Classes</a>
          <a href="./index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="file-metadata">
      <div id="file-list-section" class="section">
        <h3 class="section-header">In Files</h3>
        <div class="section-body">
          <ul>
          
            <li><a href="./old/collector_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
              class="thickbox" title="old/collector.rb">old/collector.rb</a></li>
          
          </ul>
        </div>
      </div>

      
    </div>

    <div id="class-metadata">
      
      <!-- Parent Class -->
      <div id="parent-class-section" class="section">
        <h3 class="section-header">Parent</h3>
        
        <p class="link"><a href="Object.html">Object</a></p>
        
      </div>
      

      

      

      
      <!-- Method Quickref -->
      <div id="method-list-section" class="section">
        <h3 class="section-header">Methods</h3>
        <ul class="link-list">
          
          <li><a href="#method-c-new">::new</a></li>
          
          <li><a href="#method-i-collect">#collect</a></li>
          
          <li><a href="#method-i-fetch_files_from">#fetch_files_from</a></li>
          
          <li><a href="#method-i-get_stored_files">#get_stored_files</a></li>
          
          <li><a href="#method-i-store_new_files">#store_new_files</a></li>
          
        </ul>
      </div>
      

      
    </div>

    <div id="project-metadata">
      
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class/Module Index
          <span class="search-toggle"><img src="./images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="./Conf.html">Conf</a></li>
        
          <li><a href="./Conf/ActionField.html">Conf::ActionField</a></li>
        
          <li><a href="./Conf/App.html">Conf::App</a></li>
        
          <li><a href="./Conf/Database.html">Conf::Database</a></li>
        
          <li><a href="./Conf/Directories.html">Conf::Directories</a></li>
        
          <li><a href="./Conf/FileManager.html">Conf::FileManager</a></li>
        
          <li><a href="./Conf/Filter.html">Conf::Filter</a></li>
        
          <li><a href="./Conf/Flow.html">Conf::Flow</a></li>
        
          <li><a href="./Conf/Host.html">Conf::Host</a></li>
        
          <li><a href="./Conf/ListField.html">Conf::ListField</a></li>
        
          <li><a href="./Conf/LocalFileManager.html">Conf::LocalFileManager</a></li>
        
          <li><a href="./Conf/Logging.html">Conf::Logging</a></li>
        
          <li><a href="./Conf/MeanField.html">Conf::MeanField</a></li>
        
          <li><a href="./Conf/Monitor.html">Conf::Monitor</a></li>
        
          <li><a href="./Conf/NullFilter.html">Conf::NullFilter</a></li>
        
          <li><a href="./Conf/SftpFileManager.html">Conf::SftpFileManager</a></li>
        
          <li><a href="./Conf/Source.html">Conf::Source</a></li>
        
          <li><a href="./Conf/Stats.html">Conf::Stats</a></li>
        
          <li><a href="./Conf/SumField.html">Conf::SumField</a></li>
        
          <li><a href="./Database.html">Database</a></li>
        
          <li><a href="./Database/GenericTable.html">Database::GenericTable</a></li>
        
          <li><a href="./Database/Mysql.html">Database::Mysql</a></li>
        
          <li><a href="./Database/Mysql/Result.html">Database::Mysql::Result</a></li>
        
          <li><a href="./Database/Schema.html">Database::Schema</a></li>
        
          <li><a href="./Database/Schema/Monitor.html">Database::Schema::Monitor</a></li>
        
          <li><a href="./Database/Schema/Monitor/GenericSchema.html">Database::Schema::Monitor::GenericSchema</a></li>
        
          <li><a href="./Database/Schema/Monitor/NewGenericSchema.html">Database::Schema::Monitor::NewGenericSchema</a></li>
        
          <li><a href="./Database/Schema/Source.html">Database::Schema::Source</a></li>
        
          <li><a href="./Database/Schema/Source/FileCountSchema.html">Database::Schema::Source::FileCountSchema</a></li>
        
          <li><a href="./Database/Schema/Source/GenericSchema.html">Database::Schema::Source::GenericSchema</a></li>
        
          <li><a href="./Database/Schema/Source/IndexerSchema.html">Database::Schema::Source::IndexerSchema</a></li>
        
          <li><a href="./Database/Schema/Source/ProceraSchema.html">Database::Schema::Source::ProceraSchema</a></li>
        
          <li><a href="./Database/SqlGenerator.html">Database::SqlGenerator</a></li>
        
          <li><a href="./Database/TableRotator.html">Database::TableRotator</a></li>
        
          <li><a href="./Database/TableUtil.html">Database::TableUtil</a></li>
        
          <li><a href="./Mapper.html">Mapper</a></li>
        
          <li><a href="./Mapper/GenericMapper.html">Mapper::GenericMapper</a></li>
        
          <li><a href="./Mapper/LogicaMapper.html">Mapper::LogicaMapper</a></li>
        
          <li><a href="./Mapper/MmsOutMapper.html">Mapper::MmsOutMapper</a></li>
        
          <li><a href="./Mapper/Nkm15Mapper.html">Mapper::Nkm15Mapper</a></li>
        
          <li><a href="./Mapper/PGWMapper.html">Mapper::PGWMapper</a></li>
        
          <li><a href="./Mapper/ProceraMapper.html">Mapper::ProceraMapper</a></li>
        
          <li><a href="./Mapper/SmsMapper.html">Mapper::SmsMapper</a></li>
        
          <li><a href="./Mapper/TAPMapper.html">Mapper::TAPMapper</a></li>
        
          <li><a href="./Mapper/TalMapper.html">Mapper::TalMapper</a></li>
        
          <li><a href="./Mapper/XDRMapper.html">Mapper::XDRMapper</a></li>
        
          <li><a href="./Decoder.html">Decoder</a></li>
        
          <li><a href="./Decoder/BigCSVDecoder.html">Decoder::BigCSVDecoder</a></li>
        
          <li><a href="./Decoder/CSVDecoder.html">Decoder::CSVDecoder</a></li>
        
          <li><a href="./Decoder/CSVFields.html">Decoder::CSVFields</a></li>
        
          <li><a href="./Decoder/LogicaDecoder.html">Decoder::LogicaDecoder</a></li>
        
          <li><a href="./Decoder/NKM15Decoder.html">Decoder::NKM15Decoder</a></li>
        
          <li><a href="./Decoder/NullDecoder.html">Decoder::NullDecoder</a></li>
        
          <li><a href="./Decoder/PGWDecoder.html">Decoder::PGWDecoder</a></li>
        
          <li><a href="./Decoder/TALDecoder.html">Decoder::TALDecoder</a></li>
        
          <li><a href="./Decoder/XDRDecoder.html">Decoder::XDRDecoder</a></li>
        
          <li><a href="./Inserter.html">Inserter</a></li>
        
          <li><a href="./Inserter/BigSourceInserter.html">Inserter::BigSourceInserter</a></li>
        
          <li><a href="./Inserter/GenericSourceInserter.html">Inserter::GenericSourceInserter</a></li>
        
          <li><a href="./Inserter/NullSourceInserter.html">Inserter::NullSourceInserter</a></li>
        
          <li><a href="./Inserter/PGWInserter.html">Inserter::PGWInserter</a></li>
        
          <li><a href="./Parser.html">Parser</a></li>
        
          <li><a href="./Parser/CheckParser.html">Parser::CheckParser</a></li>
        
          <li><a href="./Parser/DatabaseParser.html">Parser::DatabaseParser</a></li>
        
          <li><a href="./Parser/DirectoriesParser.html">Parser::DirectoriesParser</a></li>
        
          <li><a href="./Parser/OperationParser.html">Parser::OperationParser</a></li>
        
          <li><a href="./Getter.html">Getter</a></li>
        
          <li><a href="./Getter/FileCountGetter.html">Getter::FileCountGetter</a></li>
        
          <li><a href="./Getter/GenericSourceGetter.html">Getter::GenericSourceGetter</a></li>
        
          <li><a href="./Getter/NullSourceGetter.html">Getter::NullSourceGetter</a></li>
        
          <li><a href="./Fetchers.html">Fetchers</a></li>
        
          <li><a href="./Fetchers/LocalFileFetcher.html">Fetchers::LocalFileFetcher</a></li>
        
          <li><a href="./Fetchers/SftpFileFetcher.html">Fetchers::SftpFileFetcher</a></li>
        
          <li><a href="./Stats.html">Stats</a></li>
        
          <li><a href="./Stats/BacklogStats.html">Stats::BacklogStats</a></li>
        
          <li><a href="./Stats/GenericStats.html">Stats::GenericStats</a></li>
        
          <li><a href="./CDR.html">CDR</a></li>
        
          <li><a href="./CDR/File.html">CDR::File</a></li>
        
          <li><a href="./IncludeModule.html">IncludeModule</a></li>
        
          <li><a href="./IncludeModule/ModuleClass.html">IncludeModule::ModuleClass</a></li>
        
          <li><a href="./Collector.html">Collector</a></li>
        
          <li><a href="./Debug.html">Debug</a></li>
        
          <li><a href="./EMMConfig.html">EMMConfig</a></li>
        
          <li><a href="./Fixnum.html">Fixnum</a></li>
        
          <li><a href="./Lazy.html">Lazy</a></li>
        
          <li><a href="./LazyLispyEnumerable.html">LazyLispyEnumerable</a></li>
        
          <li><a href="./LispyEnumerable.html">LispyEnumerable</a></li>
        
          <li><a href="./Logger.html">Logger</a></li>
        
          <li><a href="./MysqlDumper.html">MysqlDumper</a></li>
        
          <li><a href="./Object.html">Object</a></li>
        
          <li><a href="./RubyUtil.html">RubyUtil</a></li>
        
          <li><a href="./SignalHandler.html">SignalHandler</a></li>
        
          <li><a href="./SuperTest.html">SuperTest</a></li>
        
          <li><a href="./T1.html">T1</a></li>
        
          <li><a href="./T2.html">T2</a></li>
        
          <li><a href="./Test.html">Test</a></li>
        
          <li><a href="./Test2.html">Test2</a></li>
        
          <li><a href="./TestParser.html">TestParser</a></li>
        
          <li><a href="./Util.html">Util</a></li>
        
          <li><a href="./ValueModule.html">ValueModule</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    <h1 class="class">Collector</h1>

    <div id="description" class="description">
      
    </div><!-- description -->

    
    
    
    <div id="5Buntitled-5D" class="documentation-section">
      

      

      

      

      <!-- Methods -->
      
      <div id="public-class-method-details" class="method-section section">
        <h3 class="section-header">Public Class Methods</h3>

      
        <div id="new-method" class="method-detail ">
          <a name="method-c-new"></a>

          
          <div class="method-heading">
            <span class="method-name">new</span><span
              class="method-args">(table,fetchers)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>fetchers is a special hash key : hosts value : hash =&gt;</p>

<pre>[:fetcher] = the created fetcher for this host
[:switches] = arr of switches on this host
[:base_path] = the base path on this host</pre>
            

            
            <div class="method-source-code" id="new-source">
<pre>
<span class="ruby-comment"># File old/collector.rb, line 46</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">table</span>,<span class="ruby-identifier">fetchers</span>)
        <span class="ruby-ivar">@table</span> = <span class="ruby-identifier">table</span>
        <span class="ruby-ivar">@fetchers</span> = <span class="ruby-identifier">fetchers</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- new-source -->
            
          </div>

          

          
        </div><!-- new-method -->

      
      </div><!-- public-class-method-details -->
    
      <div id="public-instance-method-details" class="method-section section">
        <h3 class="section-header">Public Instance Methods</h3>

      
        <div id="collect-method" class="method-detail ">
          <a name="method-i-collect"></a>

          
          <div class="method-heading">
            <span class="method-name">collect</span><span
              class="method-args">(opts = {})</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>main method opts may contains specific search fields aside file_name, +
others-.– example : opts = {    where: { processed:“0” } ,</p>

<pre>down_dir: &quot;data/backlog&quot; }</pre>
            

            
            <div class="method-source-code" id="collect-source">
<pre>
<span class="ruby-comment"># File old/collector.rb, line 57</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">collect</span> <span class="ruby-identifier">opts</span> = {}
        <span class="ruby-identifier">new_files</span> = {}
        <span class="ruby-ivar">@fetchers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">host</span>,<span class="ruby-identifier">val</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">new_files</span>[<span class="ruby-identifier">host</span>] = <span class="ruby-identifier">fetch_files_from</span> <span class="ruby-identifier">val</span>       
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">files_to_keep</span> = <span class="ruby-identifier">get_stored_files</span> <span class="ruby-identifier">new_files</span>, <span class="ruby-identifier">opts</span>

        <span class="ruby-identifier">count</span> = <span class="ruby-identifier">store_new_files</span> <span class="ruby-identifier">files_to_keep</span>, <span class="ruby-identifier">opts</span>

        <span class="ruby-constant">Logger</span>.<span class="ruby-operator">&lt;&lt;</span>(<span class="ruby-identifier">$0</span>,<span class="ruby-string">&quot;INFO&quot;</span>,<span class="ruby-node">&quot;Collected #{count} files in total !&quot;</span>)
<span class="ruby-keyword">end</span></pre>
            </div><!-- collect-source -->
            
          </div>

          

          
        </div><!-- collect-method -->

      
        <div id="fetch_files_from-method" class="method-detail ">
          <a name="method-i-fetch_files_from"></a>

          
          <div class="method-heading">
            <span class="method-name">fetch_files_from</span><span
              class="method-args">(host)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>fetch files from host in every path specified</p>
            

            
            <div class="method-source-code" id="fetch_files_from-source">
<pre>
<span class="ruby-comment"># File old/collector.rb, line 118</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">fetch_files_from</span> <span class="ruby-identifier">host</span>
        <span class="ruby-identifier">fetcher</span> = <span class="ruby-identifier">host</span>[<span class="ruby-value">:fetcher</span>]
        <span class="ruby-identifier">switches</span> = <span class="ruby-identifier">host</span>[<span class="ruby-value">:switches</span>]
        <span class="ruby-identifier">base_path</span> = <span class="ruby-identifier">host</span>[<span class="ruby-value">:base_path</span>]
        <span class="ruby-identifier">list_files</span> = {}
        <span class="ruby-identifier">fetcher</span>.<span class="ruby-identifier">connect</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">switches</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">path</span> = <span class="ruby-identifier">base_path</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;/&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;/&quot;</span>
                <span class="ruby-identifier">list_files</span>[<span class="ruby-identifier">s</span>] = <span class="ruby-identifier">fetcher</span>.<span class="ruby-identifier">list_files_from</span> <span class="ruby-identifier">path</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">list_files</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- fetch_files_from-source -->
            
          </div>

          

          
        </div><!-- fetch_files_from-method -->

      
        <div id="get_stored_files-method" class="method-detail ">
          <a name="method-i-get_stored_files"></a>

          
          <div class="method-heading">
            <span class="method-name">get_stored_files</span><span
              class="method-args">(new_files, opts = {})</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>retrieve from the DB the files already processed / fetch from the list of
new files transform the new_files to only have the new</p>
            

            
            <div class="method-source-code" id="get_stored_files-source">
<pre>
<span class="ruby-comment"># File old/collector.rb, line 134</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_stored_files</span> <span class="ruby-identifier">new_files</span>, <span class="ruby-identifier">opts</span> = {}
        <span class="ruby-comment">#prepare the query</span>
        <span class="ruby-identifier">select</span> = [<span class="ruby-string">&quot;*&quot;</span>]
        <span class="ruby-identifier">select</span> = <span class="ruby-identifier">ops</span>[<span class="ruby-value">:select</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:select</span>]

        <span class="ruby-identifier">flat_files</span> = <span class="ruby-identifier">new_files</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">h</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">sw</span>,<span class="ruby-identifier">list</span><span class="ruby-operator">|</span> <span class="ruby-identifier">list</span>.<span class="ruby-identifier">to_a</span> }.<span class="ruby-identifier">flatten</span>(<span class="ruby-value">1</span>) }.<span class="ruby-identifier">flatten</span>(<span class="ruby-value">1</span>)
        <span class="ruby-identifier">where</span> = { <span class="ruby-identifier">file_name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">flat_files</span> }
        <span class="ruby-identifier">where</span>.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:where</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:where</span>]
        
        <span class="ruby-comment">#make the query</span>
        <span class="ruby-identifier">res</span> = <span class="ruby-ivar">@table</span>.<span class="ruby-identifier">search_and</span>(<span class="ruby-identifier">select</span>,<span class="ruby-identifier">where</span>)
        <span class="ruby-comment"># just transform result in a more flexible manner     </span>
        <span class="ruby-identifier">alreadyStored</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">res</span>.<span class="ruby-identifier">each_hash</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">alreadyStored</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">'file_name'</span>]
        <span class="ruby-keyword">end</span>
        <span class="ruby-constant">Logger</span>.<span class="ruby-operator">&lt;&lt;</span>(<span class="ruby-identifier">$0</span>,<span class="ruby-string">&quot;INFO&quot;</span>,<span class="ruby-node">&quot;Retrieved #{alreadyStored.size} file names from database ...&quot;</span>)           
        <span class="ruby-comment">## conpute the difference</span>
        <span class="ruby-comment">## and transform into array for easier manipulation</span>
        <span class="ruby-comment">## (Set is fast for difference)</span>
        <span class="ruby-identifier">count</span> = <span class="ruby-value">0</span>
        <span class="ruby-identifier">files_to_keep</span> = <span class="ruby-identifier">new_files</span>.<span class="ruby-identifier">clone</span>
        <span class="ruby-identifier">new_files</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h</span>,<span class="ruby-identifier">sws</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">sws</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">sw</span>,<span class="ruby-identifier">list</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">files_to_keep</span>[<span class="ruby-identifier">h</span>][<span class="ruby-identifier">sw</span>] = (<span class="ruby-identifier">new_files</span>[<span class="ruby-identifier">h</span>][<span class="ruby-identifier">sw</span>].<span class="ruby-identifier">subtract</span> <span class="ruby-identifier">alreadyStored</span>).<span class="ruby-identifier">to_a</span>
                    <span class="ruby-identifier">count</span> = <span class="ruby-identifier">count</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">new_files</span>[<span class="ruby-identifier">h</span>][<span class="ruby-identifier">sw</span>].<span class="ruby-identifier">size</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-constant">Logger</span>.<span class="ruby-operator">&lt;&lt;</span>(<span class="ruby-identifier">$0</span>,<span class="ruby-string">&quot;INFO&quot;</span>,<span class="ruby-node">&quot;Will keep only #{count} files among retrieved&quot;</span>)
        <span class="ruby-identifier">files_to_keep</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- get_stored_files-source -->
            
          </div>

          

          
        </div><!-- get_stored_files-method -->

      
        <div id="store_new_files-method" class="method-detail ">
          <a name="method-i-store_new_files"></a>

          
          <div class="method-heading">
            <span class="method-name">store_new_files</span><span
              class="method-args">(new_files , opts={})</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>download all the enw files, and put it in db TODO verify the speed of this
maybe download ALL FILES in ONE batch here, download from all files from
one directory at a time</p>
            

            
            <div class="method-source-code" id="store_new_files-source">
<pre>
<span class="ruby-comment"># File old/collector.rb, line 73</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">store_new_files</span> <span class="ruby-identifier">new_files</span> , <span class="ruby-identifier">opts</span>={}
        <span class="ruby-identifier">count</span> = <span class="ruby-value">0</span>
        <span class="ruby-ivar">@fetchers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">host</span>,<span class="ruby-identifier">val</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">fetcher</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">:fetcher</span>]
                <span class="ruby-identifier">base_path</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">:base_path</span>]
                <span class="ruby-comment"># custom download path</span>
                <span class="ruby-identifier">down_dir</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:down_dir</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-constant">EMMConfig</span>[<span class="ruby-string">'DATA_DOWN_DIR'</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:down_dir</span>]
                <span class="ruby-identifier">down_dir</span> = <span class="ruby-constant">Util</span>.<span class="ruby-identifier">data_path</span>(<span class="ruby-identifier">down_dir</span>)
                <span class="ruby-identifier">fetcher</span>.<span class="ruby-identifier">connect</span> <span class="ruby-keyword">do</span>
                <span class="ruby-comment">## The download it self</span>
                <span class="ruby-identifier">new_files</span>[<span class="ruby-identifier">host</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">sw</span>,<span class="ruby-identifier">list</span><span class="ruby-operator">|</span>
                        <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">list</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                        <span class="ruby-identifier">local_dir</span> = <span class="ruby-node">&quot;#{down_dir}/#{sw}&quot;</span>
                        <span class="ruby-identifier">remote_dir</span> =<span class="ruby-node">&quot;#{base_path}/#{sw}&quot;</span>
                        <span class="ruby-identifier">fetcher</span>.<span class="ruby-identifier">download_files</span>(<span class="ruby-identifier">local_dir</span>,<span class="ruby-identifier">remote_dir</span>,<span class="ruby-identifier">list</span>)
                        
                        <span class="ruby-constant">Logger</span>.<span class="ruby-operator">&lt;&lt;</span>(<span class="ruby-identifier">$0</span>,<span class="ruby-string">&quot;INFO&quot;</span>,<span class="ruby-node">&quot;Downloaded #{list.size} files from #{sw}&quot;</span>)

                        <span class="ruby-comment">## since nothing went wrong we can move them</span>
                        <span class="ruby-identifier">store_dir</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:store_dir</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-constant">EMMConfig</span>[<span class="ruby-string">'DATA_STORE_DIR'</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:store_dir</span>] 
                        <span class="ruby-identifier">store_dir</span> = <span class="ruby-constant">Util</span>.<span class="ruby-identifier">data_path</span>(<span class="ruby-identifier">store_dir</span>)
                        <span class="ruby-identifier">cmd</span> = <span class="ruby-node">&quot;mv -t #{store_dir}/#{sw} #{list.map{|f| local_dir +&quot;/&quot;+ f }.join(' ')} 2&gt;&amp;1&quot;</span>
                        <span class="ruby-identifier">res</span> = <span class="ruby-node">`#{cmd}`</span>      
                        <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">res</span>.<span class="ruby-identifier">empty?</span> 
                                <span class="ruby-constant">Logger</span>.<span class="ruby-operator">&lt;&lt;</span>(<span class="ruby-identifier">$0</span>,<span class="ruby-string">&quot;ERROR&quot;</span>,<span class="ruby-node">&quot;while executing the mv command: res=#{res} \ncmd = #{cmd}&quot;</span>)
                                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Error during the mv command&quot;</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-constant">Logger</span>.<span class="ruby-operator">&lt;&lt;</span>(<span class="ruby-identifier">$0</span>,<span class="ruby-string">&quot;INFO&quot;</span>,<span class="ruby-node">&quot;Moved #{list.size} files to  #{store_dir}/#{sw}&quot;</span>)

                        <span class="ruby-comment">## insert in db</span>
                        <span class="ruby-identifier">h</span> = { <span class="ruby-identifier">fields</span><span class="ruby-operator">:</span> [<span class="ruby-string">&quot;file_name&quot;</span>,<span class="ruby-string">&quot;switch&quot;</span>] }
                        <span class="ruby-identifier">h</span>[<span class="ruby-value">:values</span>] = <span class="ruby-identifier">list</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">f</span>,<span class="ruby-identifier">sw</span>]}
                        <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@table</span>.<span class="ruby-identifier">insert_multiple</span>  <span class="ruby-identifier">h</span>
            <span class="ruby-constant">Logger</span>.<span class="ruby-operator">&lt;&lt;</span>(<span class="ruby-identifier">$0</span>,<span class="ruby-string">&quot;ERROR&quot;</span>,<span class="ruby-string">&quot;Error during database transaction. Aborting.&quot;</span>)
            <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Database transaction error. Abort.&quot;</span>
        <span class="ruby-keyword">end</span>
                        <span class="ruby-constant">Logger</span>.<span class="ruby-operator">&lt;&lt;</span>(<span class="ruby-identifier">$0</span>,<span class="ruby-string">&quot;INFO&quot;</span>,<span class="ruby-node">&quot;Registered #{list.size} files in #{@table.table_name} &quot;</span>)
                        <span class="ruby-identifier">count</span> = <span class="ruby-identifier">count</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">list</span>.<span class="ruby-identifier">size</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">count</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- store_new_files-source -->
            
          </div>

          

          
        </div><!-- store_new_files-method -->

      
      </div><!-- public-instance-method-details -->
    
    </div><!-- 5Buntitled-5D -->
  

  </div><!-- documentation -->

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>

</body>
</html>

